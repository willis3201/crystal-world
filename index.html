<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFPS v2.2 - æ°´æ™¶é »ç‡å®šä½ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #bd00ff;
            --accent: #ffb700;
            --success: #00ff40; /* å­”é›€çŸ³ç¶  */
            --bg: #0a0a12;
            --panel: #161622;
            --text: #e0e0e0;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h2 {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            margin-bottom: 5px;
        }

        /* ä¸Šå‚³å€å¡Š */
        .upload-section {
            background: var(--panel);
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-section:hover {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.1);
        }

        #previewImage {
            max-width: 100%;
            max-height: 300px;
            display: none;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* æŒ‰éˆ• */
        .btn-analyze {
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            border: none;
            color: white;
            padding: 15px;
            width: 100%;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            text-transform: uppercase;
        }
        .btn-analyze:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        /* çµæœé¢æ¿ */
        .results-panel {
            display: none; /* åˆå§‹éš±è— */
            background: var(--panel);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .freq-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .freq-number {
            font-size: 3rem;
            font-family: 'Orbitron', sans-serif;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.3);
        }

        .freq-title {
            font-size: 1.2rem;
            color: var(--accent);
            font-weight: bold;
            letter-spacing: 2px;
            margin-top: 5px;
        }

        .log-box {
            background: #000;
            padding: 12px;
            height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #0f0;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid var(--secondary);
        }
        
        /* éš±è— Canvas ç”¨æ–¼è¨ˆç®— */
        #analysisCanvas {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>CFPS <span style="color:var(--primary)">v2.2</span> PATCHED</h2>
    <p style="text-align:center; color:#666; font-size:0.8rem; margin-top:-10px;">åŒ…å«è†šè‰²éæ¿¾èˆ‡å­”é›€çŸ³æ•¸æ“šåº«</p>

    <canvas id="analysisCanvas"></canvas>

    <div class="upload-section" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)" style="display:none;">
        <div id="uploadPlaceholder">
            <div style="font-size:3rem; margin-bottom:10px;">ğŸ“·</div>
            <h3>é»æ“Šä¸Šå‚³æ¸¬è©¦ç…§ç‰‡</h3>
            <p style="color:#888; font-size:0.9rem;">æ”¯æ´è‡ªå‹•æ¿¾é™¤èƒŒæ™¯é›œè¨Š</p>
        </div>
        <img id="previewImage" src="" alt="Crystal Preview">
    </div>

    <button class="btn-analyze" id="analyzeBtn" onclick="runDynamicAnalysis()" disabled>å•Ÿå‹• AI è¦–è¦ºåˆ†æ</button>

    <div class="results-panel" id="resultsPanel">
        <div class="freq-display">
            <div class="freq-number" id="finalFreq">--- Hz</div>
            <div class="freq-title" id="finalTitle">CALCULATING...</div>
        </div>
        
        <div style="position: relative; height:250px; width:100%;">
            <canvas id="radarChart"></canvas>
        </div>

        <div class="log-box" id="systemLog">
            <div>> System Ready. v2.2 Loaded.</div>
        </div>
    </div>
</div>

<script>
    // --- 1. æ™¶çŸ³æ•¸æ“šåº« (æ–°å¢ Malachite) ---
    const crystalDatabase = {
        'amethyst': { 
            name: 'ç´«æ°´æ™¶ (Amethyst)', 
            baseHz: 963, 
            type: 'Spiritual', 
            color: '#bd00ff', 
            desc: 'é ‚è¼ªé–‹å•Ÿã€ç¥æ€§é€£æ¥' 
        },
        'blue_tiger': { 
            name: 'è—è™çœ¼ (Blue Tiger Eye)', 
            baseHz: 680, 
            type: 'Insight', 
            color: '#00f2ff', 
            desc: 'çœ‰å¿ƒè¼ªã€æ´å¯ŸåŠ›' 
        },
        'citrine': { 
            name: 'é»ƒæ°´æ™¶/éˆ¦æ™¶ (Citrine)', 
            baseHz: 528, 
            type: 'Manifest', 
            color: '#ffb700', 
            desc: 'å¤ªé™½è¼ªã€è²¡å¯Œé¡¯åŒ–' 
        },
        'obsidian': { 
            name: 'é»‘æ›œçŸ³ (Obsidian)', 
            baseHz: 396, 
            type: 'Grounding', 
            color: '#888888', 
            desc: 'æµ·åº•è¼ªã€å¼·åŠ›æ‰æ ¹' 
        },
        'malachite': { 
            name: 'å­”é›€çŸ³ (Malachite)', 
            baseHz: 639, 
            type: 'Healing', 
            color: '#00ff40', 
            desc: 'å¿ƒè¼ªã€è½‰åŒ–èˆ‡ç™‚ç™’' 
        },
        'mixed_strategy': { 
            name: 'æ··åˆæˆ°ç•¥ (Mixed)', 
            baseHz: 639, 
            type: 'Synergy', 
            color: '#0088ff', 
            desc: 'ã€æˆ°ç•¥æŒ‡æ®å®˜ã€‘è¤‡åˆèƒ½é‡' 
        }
    };

    let currentImgElement = null;

    // --- æ—¥èªŒåŠŸèƒ½ ---
    function log(msg) {
        const box = document.getElementById('systemLog');
        const time = new Date().toLocaleTimeString('en-US', {hour12: false, hour: "numeric", minute: "numeric", second: "numeric"});
        box.innerHTML += `<div>[${time}] ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    // --- æ–‡ä»¶è™•ç† ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('previewImage');
                img.src = e.target.result;
                img.style.display = 'block';
                currentImgElement = img;
                
                document.getElementById('uploadPlaceholder').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
                
                // é‡ç½®ä¸¦éš±è—çµæœé¢æ¿
                document.getElementById('resultsPanel').style.display = 'none';
                document.getElementById('systemLog').innerHTML = '<div>> Image loaded. Ready.</div>';
            };
            reader.readAsDataURL(file);
        }
    }

    // --- æ ¸å¿ƒé‹ç®— ---
    function runDynamicAnalysis() {
        document.getElementById('resultsPanel').style.display = 'block';
        log("Scanning image pixel data...");

        const canvas = document.getElementById('analysisCanvas');
        const ctx = canvas.getContext('2d');
        const img = currentImgElement;
        
        // ç¸®å°åœ–ç‰‡ä»¥åŠ é€Ÿè¨ˆç®—ï¼Œä½†ä¿æŒè¶³å¤ ç´°ç¯€
        canvas.width = 100;
        canvas.height = 100;
        ctx.drawImage(img, 0, 0, 100, 100);
        
        const frame = ctx.getImageData(0, 0, 100, 100);
        const data = frame.data;
        
        let r_sum = 0, g_sum = 0, b_sum = 0;
        let pixelCount = 0;

        // --- ğŸ¤– æ™ºèƒ½æ¡æ¨£ç®—æ³• (Skin Tone / Grey Filter) ---
        // æˆ‘å€‘åªè¨ˆç®—ã€Œæœ‰è‰²å½©å‚¾å‘ã€çš„åƒç´ ï¼Œå¿½ç•¥ç°è‰²å’Œè†šè‰²(é€šå¸¸é£½å’Œåº¦ä½)
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i];
            let g = data[i+1];
            let b = data[i+2];

            let max = Math.max(r, g, b);
            let min = Math.min(r, g, b);
            let saturation = max - min; // ç°¡å–®çš„é£½å’Œåº¦è¨ˆç®—

            // é–¾å€¼è¨­å®šï¼šå¦‚æœ RGB å·®ç•°å°æ–¼ 20ï¼Œè¦–ç‚ºç°è‰²/èƒŒæ™¯/çš®è†šåå…‰ï¼Œä¸è¨ˆå…¥
            if (saturation > 20) { 
                r_sum += r;
                g_sum += g;
                b_sum += b;
                pixelCount++;
            }
        }

        // é˜²æ­¢é™¤ä»¥é›¶
        if (pixelCount === 0) { pixelCount = 1; }

        let r = Math.floor(r_sum / pixelCount);
        let g = Math.floor(g_sum / pixelCount);
        let b = Math.floor(b_sum / pixelCount);

        log(`Filtered RGB: (${r}, ${g}, ${b})`);
        log(`Valid Pixels: ${Math.floor((pixelCount/2500)*100)}% coverage`);

        // --- ğŸŒˆ è‰²å½©åˆ¤å®šé‚è¼¯ ---
        let detectedType = 'obsidian'; // é»˜èª
        
        // 1. å­”é›€çŸ³/ç¶ è‰²åˆ¤å®š (å„ªå…ˆç´šé«˜)
        // ç¶ è‰²åˆ†é‡æ˜é¡¯å¤§æ–¼ç´…å’Œè—
        if (g > r + 10 && g > b + 10) {
            detectedType = 'malachite';
        }
        // 2. ç´«è‰²åˆ¤å®š
        else if (r > 100 && b > 100 && g < 100) {
            detectedType = 'amethyst';
        } 
        // 3. è—è‰²åˆ¤å®š
        else if (b > r + 20 && b > g) {
             // ç°¡å–®é‚è¼¯ï¼šè—è‰²ç³»çµ±ä¸€å…ˆæ­¸é¡ç‚ºè—è™çœ¼
            detectedType = 'blue_tiger'; 
        }
        // 4. é»ƒè‰²/é‡‘è‰²åˆ¤å®š
        else if (r > 120 && g > 100 && b < 100) {
            detectedType = 'citrine';
        }
        // 5. é»‘è‰²/æ·±è‰²åˆ¤å®š
        // å¦‚æœç¶“ééæ¿¾å¾Œæ•¸å€¼ä¾ç„¶å¾ˆä½ï¼Œæˆ–è€…ç„¡æ³•æ­¸é¡
        else {
            detectedType = 'obsidian';
        }
        
        // *Demo éš¨æ©Ÿæ€§*ï¼šé‡å°è—è™çœ¼çš„æ··åˆæˆ°ç•¥ (ä¿ç•™æ­¤åŠŸèƒ½ä»¥æ¼”ç¤ºç‰¹æ®ŠID)
        if (detectedType === 'blue_tiger' && Math.random() > 0.8) {
            detectedType = 'mixed_strategy';
        }

        const result = crystalDatabase[detectedType];
        
        // æ¨¡æ“¬ AI æ€è€ƒæ™‚é–“
        setTimeout(() => {
            log(`AI Match: ${result.name}`);
            updateUI(result, detectedType);
        }, 600);
    }

    function updateUI(data, type) {
        document.getElementById('finalFreq').innerText = data.baseHz + " Hz";
        document.getElementById('finalFreq').style.color = data.color;
        
        let title = "UNKNOWN";
        if(type === 'mixed_strategy') title = "STRATEGIC COMMANDER";
        else if(type === 'amethyst') title = "THE AWAKENER";
        else if(type === 'blue_tiger') title = "THE INSIGHT";
        else if(type === 'citrine') title = "THE MANIFESTER";
        else if(type === 'malachite') title = "THE HEALER (ç™‚ç™’è€…)";
        else title = "THE GUARDIAN (å®ˆè­·è€…)";
        
        document.getElementById('finalTitle').innerText = title;
        document.getElementById('finalTitle').style.color = data.color;

        log(`Classification: ${title}`);
        drawRadar(type);
    }

    // --- é›·é”åœ–ç¹ªè£½ ---
    let radarChartInstance = null;
    function drawRadar(type) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        
        // å®šç¾©ä¸åŒæ°´æ™¶çš„é›·é”æ•¸å€¼ [éˆæ€§, æ‰æ ¹, é¡¯åŒ–, é˜²ç¦¦, å¿ƒè¼ª/ç›´è¦º]
        let d = [50, 50, 50, 50, 50];
        
        if (type === 'amethyst') d = [90, 20, 40, 30, 80];
        if (type === 'blue_tiger') d = [70, 40, 60, 50, 60];
        if (type === 'citrine') d = [40, 80, 90, 40, 50];
        if (type === 'obsidian') d = [20, 90, 30, 90, 40];
        if (type === 'malachite') d = [40, 50, 40, 60, 90]; // ç‰¹å¾µï¼šå¿ƒè¼ªé«˜
        if (type === 'mixed_strategy') d = [75, 75, 60, 70, 60];

        if(radarChartInstance) radarChartInstance.destroy();

        radarChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['éˆæ€§ (Spirit)', 'æ‰æ ¹ (Root)', 'é¡¯åŒ– (Action)', 'é˜²ç¦¦ (Shield)', 'å¿ƒè¼ª (Heart)'],
                datasets: [{
                    label: 'Energy Profile',
                    data: d,
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    borderColor: crystalDatabase[type] ? crystalDatabase[type].color : '#fff',
                    pointBackgroundColor: '#fff',
                    borderWidth: 2,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: '#333' },
                        grid: { color: '#333' },
                        pointLabels: { 
                            color: '#aaa',
                            font: { size: 10 }
                        },
                        ticks: { display: false, max: 100, min: 0 }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }
</script>

</body>
</html>