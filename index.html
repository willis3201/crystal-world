<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFPS v2.0 - è¤‡åˆæ°´æ™¶é »ç‡å®šä½ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #bd00ff;
            --accent: #ffb700; /* é‡‘è‰²ï¼Œä»£è¡¨é‡‘å±¬/æ··åˆ */
            --bg: #0a0a12;
            --panel: #161622;
            --text: #e0e0e0;
            --success: #00ff9d;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2, h3 { font-family: 'Orbitron', sans-serif; margin: 0; }

        .container { max-width: 900px; width: 100%; display: grid; gap: 20px; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }

        .logo {
            font-size: 1.5rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        /* è¤‡åˆåˆ†æå€å¡Š */
        .results-panel {
            display: none;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--panel);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        /* æ™¶çŸ³çµ„ä»¶æ¢ */
        .component-bar {
            display: flex;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
            background: #333;
        }
        .comp-segment { height: 100%; transition: width 1s ease; }

        .component-list {
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .comp-item { display: flex; justify-content: space-between; align-items: center; }
        .comp-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            color: #000;
        }

        /* é »ç‡å¤§å­— */
        .freq-display {
            text-align: center;
            margin: 20px 0;
        }
        .freq-number {
            font-size: 3.5rem;
            font-family: 'Orbitron', sans-serif;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
        }
        .freq-title {
            font-size: 1.2rem;
            color: var(--accent);
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* æŒ‰éˆ•èˆ‡ä¸Šå‚³ */
        .upload-section {
            background: var(--panel);
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }
        .upload-section:hover { border-color: var(--primary); }
        #previewImage { max-width: 100%; max-height: 300px; display: none; border-radius: 8px; margin-top: 10px; }
        
        .btn-analyze {
            background: linear-gradient(45deg, var(--secondary), var(--primary));
            border: none;
            color: white;
            padding: 15px;
            width: 100%;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-analyze:disabled { background: #444; cursor: not-allowed; }

        /* é‹ç®—æ—¥èªŒ */
        .log-box {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #888;
            height: 150px;
            overflow-y: auto;
            background: #000;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }
        .log-entry { margin-bottom: 5px; opacity: 0; animation: typeIn 0.3s forwards; }
        @keyframes typeIn { to { opacity: 1; } }

        /* ç‰¹æ®Šæ–‡å­—é¡è‰² */
        .txt-blue { color: var(--primary); }
        .txt-brown { color: #cd7f32; } /* å¤éŠ…è‰² */
        .txt-gold { color: var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">CFPS v2.0 <span style="font-size:0.5em; color:#666;">// COMPOSITE ENGINE</span></div>
        <div style="font-family:'Orbitron'; color:var(--success);">SYSTEM ONLINE</div>
    </header>

    <div class="upload-section" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
        <div id="uploadPlaceholder">
            <h3>ğŸ“¥ ä¸Šå‚³æ°´æ™¶æ‰‹éŠç…§ç‰‡</h3>
            <p style="color:#888;">æ”¯æ´æ··åˆæ°´æ™¶è­˜åˆ¥ (Demo æ¨¡å¼)</p>
        </div>
        <img id="previewImage" src="" alt="Preview">
    </div>

    <button class="btn-analyze" id="analyzeBtn" onclick="runCompositeAnalysis()" disabled>å•Ÿå‹•è¤‡åˆé »ç‡é‹ç®—</button>

    <div class="results-panel" id="resultsPanel">
        
        <div class="card">
            <div class="card-header">
                <h3>FREQUENCY ID</h3>
                <span style="font-size:0.8rem; color:#666;">VECTOR SYNTHESIS</span>
            </div>
            
            <div class="freq-display">
                <div class="freq-number" id="finalFreq">0 Hz</div>
                <div class="freq-title" id="finalTitle">ANALYZING...</div>
            </div>

            <div style="margin-top:20px;">
                <span style="font-size:0.8rem; color:#aaa;">COMPONENT BREAKDOWN (çµ„ä»¶æ‹†è§£)</span>
                <div class="component-bar" id="compBar"></div>
                <div class="component-list" id="compList">
                    </div>
            </div>

            <div style="margin-top: 20px; font-style: italic; color: #888; font-size: 0.9rem;" id="energyDesc">
                ç­‰å¾…åˆ†æ...
            </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="card" style="flex-grow:1;">
                <canvas id="radarChart"></canvas>
            </div>
            <div class="log-box" id="systemLog">
                <div class="log-entry">> System Ready. Waiting for input...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. æ™¶çŸ³æ•¸æ“šåº« (Mock Database) ---
    // é€™æ˜¯ç³»çµ±çš„ã€Œå¤§è…¦çŸ¥è­˜åº«ã€ï¼Œå®šç¾©äº†æ¯ç¨®çŸ³é ­çš„åŸºç¤å±¬æ€§
    const crystalDatabase = {
        'blue_tiger_eye': { 
            name: 'è—è™çœ¼ (Blue Tiger Eye)', 
            baseHz: 680, 
            type: 'Insight', 
            color: '#00f2ff',
            desc: 'æ´å¯Ÿã€å†·éœã€éæ¿¾é›œè¨Š'
        },
        'bronzite': { 
            name: 'å¤éŠ…è¼çŸ³ (Bronzite)', 
            baseHz: 430, 
            type: 'Grounding', 
            color: '#cd7f32',
            desc: 'é˜²ç¦¦ã€æ‰æ ¹ã€å¯¦æˆ°è¡Œå‹•'
        },
        'metal_charm': { 
            name: 'é‡‘å±¬ç¸é¦– (Gold Charm)', 
            baseHz: 0, 
            type: 'Conductor', 
            color: '#ffb700',
            ampFactor: 1.15, // é‡‘å±¬ä½œç‚ºæ”¾å¤§å™¨ï¼Œå¢åŠ  15% èƒ½é‡æµå‹•
            desc: 'èƒ½é‡åŒ¯èšèˆ‡ç™¼å°„'
        }
    };

    // --- 2. æ¨¡æ“¬ AI è¦–è¦ºè­˜åˆ¥çµæœ ---
    // åœ¨çœŸå¯¦ç³»çµ±ä¸­ï¼Œé€™è£¡æœƒèª¿ç”¨ Python/OpenCV è¿”å› JSON
    // ç‚ºäº†æ¼”ç¤ºï¼Œæˆ‘å€‘æ¨¡æ“¬æ‚¨æä¾›çš„ "IMG_7403.jpg" (è—è™çœ¼+å¤éŠ…è¼çŸ³+é‡‘å±¬) çš„è­˜åˆ¥çµæœ
    const mockDetectionResult = {
        confidence: 0.94,
        components: [
            { id: 'blue_tiger_eye', count: 14 },
            { id: 'bronzite', count: 2 },
            { id: 'metal_charm', count: 1 } // ä¸­é–“é‚£é¡†é‡‘å±¬
        ],
        structure: 'symmetric_center' // çµæ§‹ï¼šå°ç¨±ä¸­å¿ƒæ’åˆ—
    };

    // --- 3. æ ¸å¿ƒåŠŸèƒ½ ---

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('previewImage');
                img.src = e.target.result;
                img.style.display = 'block';
                document.getElementById('uploadPlaceholder').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
                
                // é‡ç½®ç•Œé¢
                document.getElementById('resultsPanel').style.display = 'none';
                log("> Image loaded. Waiting for analysis trigger.");
            };
            reader.readAsDataURL(file);
        }
    }

    function log(message, color = '#888') {
        const logBox = document.getElementById('systemLog');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.style.color = color;
        entry.innerText = message;
        logBox.appendChild(entry);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function runCompositeAnalysis() {
        document.getElementById('resultsPanel').style.display = 'grid';
        const logBox = document.getElementById('systemLog');
        logBox.innerHTML = ''; // æ¸…ç©º
        
        log("> Initializing CFPS v2.0 Core...", "#fff");
        
        setTimeout(() => {
            log("> Identifying components...", "var(--primary)");
            analyzeComponents(mockDetectionResult);
        }, 800);
    }

    // --- 4. è¤‡åˆé »ç‡ç®—æ³• (The Algorithm) ---
    function analyzeComponents(data) {
        let totalBeads = 0;
        let weightedHzSum = 0;
        let amplifier = 1.0;
        let detectedNames = [];
        
        // Step 1: çµ±è¨ˆèˆ‡åŸºç¤é‹ç®—
        data.components.forEach(item => {
            const dbData = crystalDatabase[item.id];
            
            if (dbData.type === 'Conductor') {
                // å¦‚æœæ˜¯é‡‘å±¬/å°é«”ï¼Œä¸è¨ˆå…¥å¹³å‡ï¼Œè€Œæ˜¯æ›´æ–°æ”¾å¤§ä¿‚æ•¸
                amplifier = dbData.ampFactor;
                log(`> Detected Conductor: ${dbData.name} (Gain: +${(amplifier-1)*100}%)`, "var(--accent)");
            } else {
                // å¦‚æœæ˜¯æ™¶çŸ³ï¼Œè¨ˆå…¥åŠ æ¬Šå¹³å‡
                totalBeads += item.count;
                weightedHzSum += (dbData.baseHz * item.count);
                log(`> Identified: ${item.count}x ${dbData.name} @ ${dbData.baseHz}Hz`, "#fff");
            }
            detectedNames.push(item.id);
        });

        // Step 2: è¨ˆç®—åŠ æ¬Šå¹³å‡é »ç‡ (Base Weighted Frequency)
        let baseAvgHz = weightedHzSum / totalBeads;
        log(`> Base Weighted Frequency: ${baseAvgHz.toFixed(1)} Hz`, "#aaa");

        // Step 3: æ‡‰ç”¨çµæ§‹èˆ‡å°é«”å¢ç›Š (Apply Structure & Gain)
        // é€™è£¡å°±æ˜¯æ‚¨æƒ³è¦çš„ã€Œç¨æœ‰é »ç‡ã€è¨ˆç®—é‚è¼¯
        let finalHz = baseAvgHz;
        
        if (data.structure === 'symmetric_center') {
             // çµæ§‹åŠ æˆï¼šå¦‚æœæ˜¯æœ‰åºæ’åˆ—ï¼Œé »ç‡æ›´ç©©å®š
            log("> Structure Analysis: Symmetric (Stabilized)", "#00ff9d");
        }

        // æ‡‰ç”¨é‡‘å±¬æ”¾å¤§
        finalHz = finalHz * amplifier;
        
        // æ ¹æ“šæ··åˆæƒ…æ³é€²è¡Œå¾®èª¿ (Synergy Effect)
        // è—è™çœ¼(é«˜) + å¤éŠ…(ä½) = ä¸­å’Œåæ‡‰
        let synergyTitle = "";
        let synergyDesc = "";
        
        if (detectedNames.includes('blue_tiger_eye') && detectedNames.includes('bronzite')) {
            log("> DETECTED SYNERGY: [Insight] + [Action]", "var(--secondary)");
            // ç‰¹æ®Šæ•¸å­¸èª¿æ•´ï¼šè®“é »ç‡è¶¨å‘æ–¼å¿ƒè¼ª/å–‰è¼ªçš„é€£æ¥é» (æºé€šèˆ‡æ±ºç­–)
            finalHz = (finalHz + 639) / 2; 
            synergyTitle = "THE STRATEGIC COMMANDER (æˆ°ç•¥æŒ‡æ®å®˜)";
            synergyDesc = "èƒ½é‡æµå‹•åˆ†æï¼šè—è™çœ¼è² è²¬æ”¶é›†æƒ…å ±èˆ‡å†·éœåˆ†æï¼Œå¤éŠ…è¼çŸ³å°‡æ„è­˜éŒ¨å®šæ–¼ç¾å¯¦ä¸¦è½‰åŒ–ç‚ºè¡Œå‹•ã€‚é‡‘å±¬æ ¸å¿ƒä½œç‚ºç™¼å°„å°ã€‚é€™æ˜¯ä¸€å€‹é©åˆã€æ±ºç­–è€…ã€èˆ‡ã€ç®¡ç†è€…ã€çš„å®Œç¾é »ç‡çµ„åˆã€‚";
        } else {
            synergyTitle = "UNKNOWN MIX";
            synergyDesc = "General mixed energy.";
        }

        log(`> FINAL COMPOSITE FREQUENCY: ${Math.round(finalHz)} Hz`, "#fff");

        // Step 4: æ›´æ–° UI
        updateUI(Math.round(finalHz), synergyTitle, synergyDesc, data);
    }

    function updateUI(freq, title, desc, data) {
        // æ›´æ–°å¤§å­—
        animateValue("finalFreq", 0, freq, 1500);
        document.getElementById('finalTitle').innerText = title;
        document.getElementById('energyDesc').innerText = desc;

        // æ›´æ–°çµ„ä»¶æ¢
        const bar = document.getElementById('compBar');
        const list = document.getElementById('compList');
        bar.innerHTML = '';
        list.innerHTML = '';

        let totalCount = 0;
        data.components.forEach(c => { if(crystalDatabase[c.id].baseHz > 0) totalCount += c.count; });

        data.components.forEach(item => {
            const db = crystalDatabase[item.id];
            
            // é€²åº¦æ¢ (åªç®—çŸ³é ­ä½”æ¯”)
            if (db.baseHz > 0) {
                const width = (item.count / totalCount) * 100;
                const seg = document.createElement('div');
                seg.className = 'comp-segment';
                seg.style.width = width + '%';
                seg.style.backgroundColor = db.color;
                bar.appendChild(seg);
            }

            // åˆ—è¡¨é …
            const li = document.createElement('div');
            li.className = 'comp-item';
            li.innerHTML = `
                <span>${db.name}</span>
                <span class="comp-badge" style="background:${db.color}">${item.count}é¡†</span>
            `;
            list.appendChild(li);
        });

        // ç¹ªè£½é›·é”åœ–
        drawRadar(data);
    }

    function animateValue(id, start, end, duration) {
        let obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start) + " Hz";
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // --- 5. ç¹ªè£½é›·é”åœ– ---
    function drawRadar(data) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        
        // ç°¡å–®åˆ¤å®šé›·é”æ•¸å€¼ (Demoç”¨)
        // è—è™çœ¼å¤š = Insighté«˜, å¤éŠ…å¤š = Groundingé«˜
        let insight = 0, grounding = 0, energy = 0;
        
        data.components.forEach(item => {
            if (item.id === 'blue_tiger_eye') insight += item.count;
            if (item.id === 'bronzite') grounding += item.count;
            if (item.id === 'metal_charm') energy += 5; // é‡‘å±¬åŠ å¼·èƒ½é‡è¼¸å‡º
        });

        // Normalize
        insight = (insight / 15) * 100;
        grounding = (grounding / 15) * 100;
        energy = 50 + energy; // åŸºç¤ 50

        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['é«˜é »æ´å¯Ÿ (Crown)', 'è¡Œå‹•é¡¯åŒ– (Root)', 'èƒ½é‡æ”¾å°„ (Output)', 'é˜²ç¦¦ (Shield)', 'å¹³è¡¡ (Heart)'],
                datasets: [{
                    label: 'è¤‡åˆèƒ½é‡æŒ‡ç´‹',
                    data: [insight, grounding, energy, 60, 50], // æ¨¡æ“¬æ•¸æ“š
                    backgroundColor: 'rgba(0, 242, 255, 0.2)',
                    borderColor: '#00f2ff',
                    pointBackgroundColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { color: '#333' },
                        grid: { color: '#333' },
                        pointLabels: { color: '#888', font: {family: 'Roboto'} },
                        ticks: { display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }
</script>

</body>
</html>