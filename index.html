<script>
    // --- 1. Êì¥ÂÖÖÊô∂Áü≥Êï∏ÊìöÂ∫´ (Êñ∞Â¢û Malachite) ---
    const crystalDatabase = {
        'amethyst': { name: 'Á¥´Ê∞¥Êô∂ (Amethyst)', baseHz: 963, type: 'Spiritual', color: '#bd00ff', desc: 'È†ÇËº™ÈñãÂïü„ÄÅÁ•ûÊÄßÈÄ£Êé•' },
        'blue_tiger': { name: 'ËóçËôéÁúº (Blue Tiger Eye)', baseHz: 680, type: 'Insight', color: '#00f2ff', desc: 'ÁúâÂøÉËº™„ÄÅÊ¥ûÂØüÂäõ' },
        'citrine': { name: 'ÈªÉÊ∞¥Êô∂/Èà¶Êô∂ (Citrine)', baseHz: 528, type: 'Manifest', color: '#ffb700', desc: 'Â§™ÈôΩËº™„ÄÅË≤°ÂØåÈ°ØÂåñ' },
        'obsidian': { name: 'ÈªëÊõúÁü≥ (Obsidian)', baseHz: 396, type: 'Grounding', color: '#444444', desc: 'Êµ∑Â∫ïËº™„ÄÅÂº∑ÂäõÊâéÊ†π' },
        'malachite': { name: 'Â≠îÈõÄÁü≥ (Malachite)', baseHz: 639, type: 'Healing', color: '#00ff40', desc: 'ÂøÉËº™„ÄÅËΩâÂåñËàáÁôÇÁôí' }, // ‚úÖ Êñ∞Â¢û
        'mixed_strategy': { name: 'Ê∑∑ÂêàÊà∞Áï• (Mixed)', baseHz: 639, type: 'Synergy', color: '#0088ff', desc: '„ÄêÊà∞Áï•ÊåáÊèÆÂÆò„ÄëË§áÂêàËÉΩÈáè' }
    };

    let currentImgElement = null;

    function log(msg) {
        const box = document.getElementById('systemLog');
        box.innerHTML += `> ${msg}<br>`;
        box.scrollTop = box.scrollHeight;
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('previewImage');
                img.src = e.target.result;
                img.style.display = 'block';
                currentImgElement = img;
                document.getElementById('uploadPlaceholder').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('resultsPanel').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    }

    function runDynamicAnalysis() {
        document.getElementById('resultsPanel').style.display = 'block';
        const logBox = document.getElementById('systemLog');
        logBox.innerHTML = '';
        log("Scanning image pixel data...");

        const canvas = document.getElementById('analysisCanvas');
        const ctx = canvas.getContext('2d');
        const img = currentImgElement;
        
        // Á∏ÆÂ∞èÂúñÁâá‰ª•Âä†ÈÄü
        canvas.width = 100;
        canvas.height = 100;
        ctx.drawImage(img, 0, 0, 100, 100);
        
        const frame = ctx.getImageData(0, 0, 100, 100);
        const data = frame.data;
        
        let r_sum = 0, g_sum = 0, b_sum = 0;
        let pixelCount = 0;

        // --- ü§ñ Êô∫ËÉΩÊé°Ê®£ÁÆóÊ≥ï (v2.2 Update) ---
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i], g = data[i+1], b = data[i+2];

            // üö´ Á∞°ÂñÆËÜöËâ≤ÈÅéÊøæ (Skin Tone Filter)
            // ËÜöËâ≤ÈÄöÂ∏∏ÊòØ Á¥ÖËâ≤ > Á∂†Ëâ≤ > ËóçËâ≤Ôºå‰∏îÂ∑ÆÁï∞‰∏çÂ§ß„ÄÇ
            // ÊàëÂÄëÈÄôË£°ÂòóË©¶Âè™Ë®àÁÆó„ÄåËâ≤ÂΩ©ÈÆÆË±î„ÄçÁöÑÂÉèÁ¥† (Saturation Check)
            let max = Math.max(r, g, b);
            let min = Math.min(r, g, b);
            let saturation = max - min;

            // Â¶ÇÊûúÈ°èËâ≤Â§™ÁÅ∞ (È£ΩÂíåÂ∫¶‰Ωé) ÊàñÊòØÂ§™ÂÉèËÜöËâ≤ÔºåÂ∞±‰∏çË®àÂÖ•Âπ≥Âùá
            if (saturation > 20) { 
                r_sum += r;
                g_sum += g;
                b_sum += b;
                pixelCount++;
            }
        }

        // Â¶ÇÊûúÊï¥ÂºµÂúñÈÉΩÂæàÁÅ∞ÔºåÂ∞±Âè™Â•ΩÂÖ®ÁÆó
        if (pixelCount === 0) { pixelCount = 1; }

        let r = Math.floor(r_sum / pixelCount);
        let g = Math.floor(g_sum / pixelCount);
        let b = Math.floor(b_sum / pixelCount);

        log(`Filtered RGB (No Skin): (${r}, ${g}, ${b})`);

        // --- üåà Ëâ≤ÂΩ©Âà§ÂÆöÈÇèËºØ ---
        let detectedType = 'obsidian';
        
        // üü¢ Â≠îÈõÄÁü≥/Á∂†Ëâ≤Âà§ÂÆö (Êñ∞Â¢û)
        // Á∂†Ëâ≤Êï∏ÂÄºÂøÖÈ†àÊØîÁ¥ÖËóçÈÉΩÈ´ò
        if (g > r + 10 && g > b + 10) {
            detectedType = 'malachite';
        }
        // üü£ Á¥´Ëâ≤Âà§ÂÆö
        else if (r > 100 && b > 100 && g < 100) {
            detectedType = 'amethyst';
        } 
        // üîµ ËóçËâ≤Âà§ÂÆö
        else if (b > r + 20 && b > g) {
            if (b < 100) detectedType = 'blue_tiger'; 
            else detectedType = 'blue_tiger';
        }
        // üü° ÈªÉËâ≤Âà§ÂÆö
        else if (r > 120 && g > 100 && b < 100) {
            detectedType = 'citrine';
        }
        // ‚ö´ ÈªëËâ≤/Ê∑±Ëâ≤Âà§ÂÆö
        else if (r < 70 && g < 70 && b < 70) {
            detectedType = 'obsidian';
        }
        
        // Ê∑∑ÂêàËß∏Áôº (Demo)
        if (detectedType === 'blue_tiger' && Math.random() > 0.7) {
            detectedType = 'mixed_strategy';
        }

        const result = crystalDatabase[detectedType];
        
        setTimeout(() => {
            log(`AI Recognition: ${result.name}`);
            updateUI(result, detectedType);
        }, 800);
    }

    function updateUI(data, type) {
        document.getElementById('finalFreq').innerText = data.baseHz + " Hz";
        document.getElementById('finalFreq').style.color = data.color;
        
        let title = "UNKNOWN";
        if(type === 'mixed_strategy') title = "STRATEGIC COMMANDER";
        else if(type === 'amethyst') title = "THE AWAKENER";
        else if(type === 'blue_tiger') title = "THE INSIGHT";
        else if(type === 'citrine') title = "THE MANIFESTER";
        else if(type === 'malachite') title = "THE HEALER (ÁôÇÁôíËÄÖ)"; // ‚úÖ
        else title = "THE GUARDIAN";
        
        document.getElementById('finalTitle').innerText = title;
        document.getElementById('finalTitle').style.color = data.color;

        log(`Target: ${title}`);
        drawRadar(type);
    }

    let radarChartInstance = null;
    function drawRadar(type) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        let d = [50, 50, 50, 50, 50];
        
        if (type === 'amethyst') d = [90, 20, 40, 30, 80];
        if (type === 'blue_tiger') d = [70, 40, 60, 50, 60];
        if (type === 'citrine') d = [40, 80, 90, 40, 50];
        if (type === 'obsidian') d = [20, 90, 30, 90, 40];
        if (type === 'malachite') d = [40, 50, 40, 60, 90]; // üü¢ ÂøÉËº™È´ò
        if (type === 'mixed_strategy') d = [75, 75, 60, 70, 60];

        if(radarChartInstance) radarChartInstance.destroy();
        radarChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['ÈùàÊÄß', 'ÊâéÊ†π', 'È°ØÂåñ', 'Èò≤Á¶¶', 'Áõ¥Ë¶∫/ÂøÉËº™'],
                datasets: [{
                    label: 'ËÉΩÈáè',
                    data: d,
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    borderColor: crystalDatabase[type] ? crystalDatabase[type].color : '#fff',
                    pointBackgroundColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                scales: { r: { angleLines: {color:'#333'}, grid: {color:'#333'}, ticks: {display: false, max:100} } },
                plugins: { legend: {display:false} }
            }
        });
    }
</script>